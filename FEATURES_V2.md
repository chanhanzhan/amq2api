# AMQ2API v2.0 - å®Œæ•´åŠŸèƒ½æ–‡æ¡£

## æ–°åŠŸèƒ½æ¦‚è§ˆ

AMQ2API v2.0 å¼•å…¥äº†ä»¥ä¸‹é‡å¤§æ–°åŠŸèƒ½ï¼š

### 1. è´¦å·æ± ç®¡ç† (Account Pool Management)
- æ”¯æŒç®¡ç†å¤šä¸ª Amazon Q è´¦å·
- è‡ªåŠ¨è´Ÿè½½å‡è¡¡å’Œè½®è¯¢
- å®æ—¶å¥åº·æ£€æŸ¥
- ä½¿ç”¨ç»Ÿè®¡å’Œç›‘æ§

### 2. API å¯†é’¥è®¤è¯ (API Key Authentication)
- å®‰å…¨çš„ API å¯†é’¥ç®¡ç†
- å…¼å®¹ Claude åè®®ï¼ˆæ”¯æŒ Authorization å’Œ x-api-key å¤´ï¼‰
- ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶
- é€Ÿç‡é™åˆ¶ï¼ˆæ¯åˆ†é’Ÿ/æ¯å¤©ï¼‰

### 3. OpenAI API æ ¼å¼æ”¯æŒ (OpenAI API Compatibility)
- å®Œæ•´æ”¯æŒ OpenAI chat completion æ ¼å¼
- è‡ªåŠ¨æ ¼å¼è½¬æ¢
- æ¨¡å‹åç§°æ˜ å°„
- æµå¼å“åº”æ”¯æŒ

### 4. Web ç®¡ç†ç•Œé¢ (Web Admin Interface)
- ç°ä»£åŒ–çš„ç®¡ç†é¢æ¿
- è´¦å·ç®¡ç†
- API å¯†é’¥ç®¡ç†
- å®æ—¶ç»Ÿè®¡å’Œç›‘æ§

---

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### åˆå§‹åŒ–æ•°æ®åº“

æ•°æ®åº“ä¼šåœ¨é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºã€‚é»˜è®¤ä½ç½®ï¼š`data/amq2api.db`

### å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨æ–°çš„åº”ç”¨æ–‡ä»¶
python app_new.py

# æˆ–ä½¿ç”¨ uvicorn
uvicorn app_new:app --host 0.0.0.0 --port 8080
```

### è®¿é—®ç®¡ç†ç•Œé¢

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:8080/admin/dashboard`

---

## è´¦å·æ± ç®¡ç†

### æ·»åŠ è´¦å·

é€šè¿‡ Web ç•Œé¢æˆ– API æ·»åŠ è´¦å·ï¼š

**é€šè¿‡ Web ç•Œé¢ï¼š**
1. è®¿é—®ç®¡ç†é¢æ¿
2. ç‚¹å‡»"è´¦å·ç®¡ç†"
3. ç‚¹å‡»"+ æ·»åŠ è´¦å·"
4. å¡«å†™è´¦å·ä¿¡æ¯

**é€šè¿‡ APIï¼š**

```bash
curl -X POST http://localhost:8080/admin/accounts \
  -H "Content-Type: application/json" \
  -d '{
    "name": "è´¦å·1",
    "refresh_token": "your_refresh_token",
    "client_id": "your_client_id",
    "client_secret": "your_client_secret",
    "profile_arn": null,
    "requests_per_minute": 10,
    "notes": "æµ‹è¯•è´¦å·"
  }'
```

### è´¦å·è½®è¯¢æœºåˆ¶

- ä½¿ç”¨ Round-Robin ç®—æ³•
- ä¼˜å…ˆé€‰æ‹© RPM æœ€ä½çš„è´¦å·
- è‡ªåŠ¨è·³è¿‡ä¸å¥åº·çš„è´¦å·
- æ”¯æŒæ¯è´¦å· RPM é™åˆ¶

### å¥åº·æ£€æŸ¥

ç³»ç»Ÿä¼šè‡ªåŠ¨è·Ÿè¸ªè´¦å·å¥åº·çŠ¶æ€ï¼š
- æˆåŠŸçš„è¯·æ±‚æ ‡è®°è´¦å·ä¸ºå¥åº·
- å¤±è´¥çš„è¯·æ±‚æ ‡è®°è´¦å·ä¸ºä¸å¥åº·
- ä¸å¥åº·çš„è´¦å·ä¼šè¢«è‡ªåŠ¨è·³è¿‡

---

## API å¯†é’¥ç®¡ç†

### åˆ›å»º API å¯†é’¥

**é€šè¿‡ Web ç•Œé¢ï¼š**
1. è®¿é—®ç®¡ç†é¢æ¿
2. ç‚¹å‡»"APIå¯†é’¥"
3. ç‚¹å‡»"+ åˆ›å»ºå¯†é’¥"
4. å¡«å†™å¯†é’¥ä¿¡æ¯
5. **é‡è¦ï¼š** åˆ›å»ºåç«‹å³ä¿å­˜å¯†é’¥ï¼Œå¯†é’¥åªæ˜¾ç¤ºä¸€æ¬¡ï¼

**é€šè¿‡ APIï¼š**

```bash
curl -X POST http://localhost:8080/admin/api-keys \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•å¯†é’¥",
    "description": "ç”¨äºæµ‹è¯•",
    "requests_per_minute": 60,
    "requests_per_day": 10000,
    "expires_days": null
  }'
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "id": 1,
  "key": "amq-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "name": "æµ‹è¯•å¯†é’¥",
  "is_active": true,
  ...
}
```

### ä½¿ç”¨ API å¯†é’¥

æ”¯æŒä¸¤ç§æ–¹å¼ä¼ é€’ API å¯†é’¥ï¼š

**æ–¹å¼ 1: Authorization Headerï¼ˆæ¨èï¼‰**

```bash
curl -X POST http://localhost:8080/v1/messages \
  -H "Authorization: Bearer amq-your-api-key-here" \
  -H "Content-Type: application/json" \
  -d '{...}'
```

**æ–¹å¼ 2: x-api-key Header**

```bash
curl -X POST http://localhost:8080/v1/messages \
  -H "x-api-key: amq-your-api-key-here" \
  -H "Content-Type: application/json" \
  -d '{...}'
```

### é€Ÿç‡é™åˆ¶

æ¯ä¸ª API å¯†é’¥æ”¯æŒï¼š
- æ¯åˆ†é’Ÿè¯·æ±‚æ•°é™åˆ¶ï¼ˆRPMï¼‰
- æ¯å¤©è¯·æ±‚æ•°é™åˆ¶ï¼ˆRPDï¼‰
- è‡ªåŠ¨é‡ç½®è®¡æ•°å™¨

---

## OpenAI API æ”¯æŒ

### ç«¯ç‚¹

```
POST /v1/chat/completions
```

### è¯·æ±‚æ ¼å¼

```bash
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Authorization: Bearer amq-your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4",
    "messages": [
      {
        "role": "system",
        "content": "You are a helpful assistant"
      },
      {
        "role": "user",
        "content": "Hello!"
      }
    ],
    "temperature": 0.7,
    "max_tokens": 1000,
    "stream": true
  }'
```

### æ¨¡å‹æ˜ å°„

| OpenAI æ¨¡å‹ | Claude æ¨¡å‹ |
|-------------|-------------|
| gpt-4 | claude-sonnet-4 |
| gpt-4-turbo | claude-sonnet-4.5 |
| gpt-4o | claude-sonnet-4.5 |
| gpt-4o-mini | claude-sonnet-4 |
| gpt-3.5-turbo | claude-sonnet-4 |

### æ”¯æŒçš„åŠŸèƒ½

- âœ… æµå¼å“åº”
- âœ… ç³»ç»Ÿæ¶ˆæ¯
- âœ… å¤šè½®å¯¹è¯
- âœ… å·¥å…·/å‡½æ•°è°ƒç”¨
- âœ… Temperature æ§åˆ¶
- âœ… Max tokens é™åˆ¶

---

## Claude API æ”¯æŒ

åŸæœ‰çš„ Claude API ç«¯ç‚¹ä»ç„¶å®Œå…¨æ”¯æŒï¼Œç°åœ¨éœ€è¦ API å¯†é’¥è®¤è¯ï¼š

```bash
curl -X POST http://localhost:8080/v1/messages \
  -H "Authorization: Bearer amq-your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-sonnet-4.5",
    "messages": [
      {
        "role": "user",
        "content": "Hello!"
      }
    ],
    "max_tokens": 4096,
    "stream": true
  }'
```

---

## ç®¡ç† API

### è´¦å·ç®¡ç†

- `GET /admin/accounts` - åˆ—å‡ºæ‰€æœ‰è´¦å·
- `POST /admin/accounts` - åˆ›å»ºè´¦å·
- `GET /admin/accounts/{id}` - è·å–è´¦å·è¯¦æƒ…
- `PUT /admin/accounts/{id}` - æ›´æ–°è´¦å·
- `DELETE /admin/accounts/{id}` - åˆ é™¤è´¦å·

### API å¯†é’¥ç®¡ç†

- `GET /admin/api-keys` - åˆ—å‡ºæ‰€æœ‰å¯†é’¥
- `POST /admin/api-keys` - åˆ›å»ºå¯†é’¥
- `GET /admin/api-keys/{id}` - è·å–å¯†é’¥è¯¦æƒ…
- `PUT /admin/api-keys/{id}` - æ›´æ–°å¯†é’¥
- `DELETE /admin/api-keys/{id}` - åˆ é™¤å¯†é’¥
- `POST /admin/api-keys/{id}/revoke` - åŠé”€å¯†é’¥

### ç»Ÿè®¡ä¿¡æ¯

- `GET /admin/stats/accounts` - è´¦å·ç»Ÿè®¡
- `GET /admin/stats/api-keys` - APIå¯†é’¥ç»Ÿè®¡

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# æ•°æ®åº“è·¯å¾„ï¼ˆå¯é€‰ï¼‰
DATABASE_PATH=data/amq2api.db

# æœåŠ¡ç«¯å£
PORT=8080

# Amazon Q API ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰
AMAZONQ_API_ENDPOINT=https://q.us-east-1.amazonaws.com/

# Token ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰
AMAZONQ_TOKEN_ENDPOINT=https://oidc.us-east-1.amazonaws.com/token
```

æ³¨æ„ï¼šä½¿ç”¨è´¦å·æ± æ¨¡å¼æ—¶ï¼Œä¸å†éœ€è¦å…¨å±€çš„ `AMAZONQ_REFRESH_TOKEN` ç­‰ç¯å¢ƒå˜é‡ã€‚

### æ•°æ®åº“

- é»˜è®¤ä½¿ç”¨ SQLite
- æ•°æ®åº“æ–‡ä»¶ï¼š`data/amq2api.db`
- è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
- æ”¯æŒçƒ­å¤‡ä»½

---

## å®‰å…¨å»ºè®®

### API å¯†é’¥å®‰å…¨

1. **å¦¥å–„ä¿ç®¡å¯†é’¥**
   - å¯†é’¥åˆ›å»ºååªæ˜¾ç¤ºä¸€æ¬¡
   - ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
   - ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥

2. **è®¾ç½®åˆç†çš„é€Ÿç‡é™åˆ¶**
   - æ ¹æ®å®é™…éœ€æ±‚è®¾ç½® RPM/RPD
   - é˜²æ­¢æ»¥ç”¨å’Œè¿‡åº¦ä½¿ç”¨

3. **å®šæœŸè½®æ¢å¯†é’¥**
   - å®šæœŸåŠé”€æ—§å¯†é’¥
   - åˆ›å»ºæ–°å¯†é’¥æ›¿æ¢

### è´¦å·å®‰å…¨

1. **åˆ†æ•£é£é™©**
   - ä½¿ç”¨å¤šä¸ªè´¦å·
   - è®¾ç½®åˆç†çš„ RPM é™åˆ¶

2. **ç›‘æ§å¥åº·çŠ¶æ€**
   - å®šæœŸæ£€æŸ¥è´¦å·å¥åº·
   - åŠæ—¶å¤„ç†å¼‚å¸¸è´¦å·

3. **å¤‡ä»½æ•°æ®åº“**
   - å®šæœŸå¤‡ä»½ `data/amq2api.db`
   - é¿å…æ•°æ®ä¸¢å¤±

---

## è¿ç§»æŒ‡å—

### ä» v1.0 è¿ç§»åˆ° v2.0

1. **å®‰è£…æ–°ä¾èµ–**
   ```bash
   pip install -r requirements.txt
   ```

2. **åˆå§‹åŒ–æ•°æ®åº“**
   ```bash
   python -c "from app.models.database import init_db; init_db()"
   ```

3. **æ·»åŠ è´¦å·**
   - é€šè¿‡ Web ç•Œé¢æ·»åŠ åŸæœ‰çš„ Amazon Q è´¦å·
   - æˆ–ä½¿ç”¨ API æ‰¹é‡å¯¼å…¥

4. **åˆ›å»º API å¯†é’¥**
   - ä¸ºç°æœ‰å®¢æˆ·ç«¯åˆ›å»º API å¯†é’¥
   - æ›´æ–°å®¢æˆ·ç«¯é…ç½®ä»¥ä½¿ç”¨æ–°å¯†é’¥

5. **æ›´æ–°å¯åŠ¨è„šæœ¬**
   ```bash
   # æ—§ç‰ˆæœ¬
   python main.py
   
   # æ–°ç‰ˆæœ¬
   python app_new.py
   ```

6. **æµ‹è¯•åŠŸèƒ½**
   - éªŒè¯è´¦å·æ± å·¥ä½œæ­£å¸¸
   - æµ‹è¯• API å¯†é’¥è®¤è¯
   - ç¡®è®¤ OpenAI API å…¼å®¹æ€§

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ— æ³•è®¿é—®ç®¡ç†ç•Œé¢

**æ£€æŸ¥ï¼š**
- æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
- ç«¯å£æ˜¯å¦è¢«å ç”¨
- é˜²ç«å¢™è®¾ç½®

### é—®é¢˜ï¼šAPI å¯†é’¥è®¤è¯å¤±è´¥

**æ£€æŸ¥ï¼š**
- å¯†é’¥æ˜¯å¦æ­£ç¡®
- å¯†é’¥æ˜¯å¦å·²æ¿€æ´»
- å¯†é’¥æ˜¯å¦å·²è¿‡æœŸ
- æ˜¯å¦è¶…å‡ºé€Ÿç‡é™åˆ¶

### é—®é¢˜ï¼šæ²¡æœ‰å¯ç”¨è´¦å·

**æ£€æŸ¥ï¼š**
- æ˜¯å¦å·²æ·»åŠ è´¦å·
- è´¦å·æ˜¯å¦æ¿€æ´»
- è´¦å·æ˜¯å¦å¥åº·
- è´¦å·æ˜¯å¦è¶…å‡º RPM é™åˆ¶

### é—®é¢˜ï¼šæ•°æ®åº“é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
1. å¤‡ä»½ç°æœ‰æ•°æ®åº“
2. åˆ é™¤æ•°æ®åº“æ–‡ä»¶
3. é‡æ–°åˆå§‹åŒ–
4. é‡æ–°å¯¼å…¥æ•°æ®

---

## æ€§èƒ½ä¼˜åŒ–

### è´¦å·æ± ä¼˜åŒ–

- æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´è´¦å·æ•°é‡
- åˆç†è®¾ç½®æ¯è´¦å· RPM é™åˆ¶
- å®šæœŸæ¸…ç†ä¸æ´»è·ƒè´¦å·

### æ•°æ®åº“ä¼˜åŒ–

- å®šæœŸæ¸…ç†æ—§çš„ä½¿ç”¨æ—¥å¿—
- ä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ ç´¢å¼•
- è€ƒè™‘è¿ç§»åˆ° PostgreSQLï¼ˆå¤§è§„æ¨¡éƒ¨ç½²ï¼‰

### ç¼“å­˜ä¼˜åŒ–

- Token ç¼“å­˜ï¼ˆå·²å®ç°ï¼‰
- å“åº”ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
- ä¼šè¯ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

---

## å¼€å‘è¯´æ˜

### é¡¹ç›®ç»“æ„

```
amq2api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/           # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ account_pool.py
â”‚   â”‚   â”œâ”€â”€ api_keys.py
â”‚   â”‚   â”œâ”€â”€ auth_middleware.py
â”‚   â”‚   â””â”€â”€ openai_converter.py
â”‚   â”œâ”€â”€ models/         # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ database.py
â”‚   â”œâ”€â”€ api/            # API ç«¯ç‚¹
â”‚   â”‚   â””â”€â”€ admin.py
â”‚   â””â”€â”€ web/            # Web ç•Œé¢
â”‚       â”œâ”€â”€ static/
â”‚       â””â”€â”€ templates/
â”œâ”€â”€ app_new.py          # æ–°ç‰ˆä¸»åº”ç”¨
â”œâ”€â”€ main.py             # æ—§ç‰ˆä¸»åº”ç”¨ï¼ˆä¿ç•™ï¼‰
â”œâ”€â”€ config.py
â”œâ”€â”€ auth.py
â”œâ”€â”€ converter.py
â”œâ”€â”€ parser.py
â””â”€â”€ ...
```

### æ‰©å±•å¼€å‘

å‚è€ƒå„æ¨¡å—çš„ä»£ç å’Œæ³¨é‡Šï¼Œå¯ä»¥è½»æ¾æ‰©å±•ï¼š
- æ·»åŠ æ–°çš„è®¤è¯æ–¹å¼
- æ”¯æŒæ›´å¤š AI æ¨¡å‹
- è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥
- æ·»åŠ æ›´å¤šç»Ÿè®¡æŒ‡æ ‡

---

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2024-11)

**æ–°åŠŸèƒ½ï¼š**
- âœ… è´¦å·æ± ç®¡ç†ç³»ç»Ÿ
- âœ… API å¯†é’¥è®¤è¯
- âœ… OpenAI API å…¼å®¹æ€§
- âœ… Web ç®¡ç†ç•Œé¢
- âœ… ä½¿ç”¨ç»Ÿè®¡å’Œç›‘æ§

**æ”¹è¿›ï¼š**
- ğŸ“ˆ æ›´å¥½çš„è´Ÿè½½å‡è¡¡
- ğŸ”’ å¢å¼ºçš„å®‰å…¨æ€§
- ğŸ“Š å®æ—¶ç›‘æ§å’Œç»Ÿè®¡
- ğŸ¨ ç°ä»£åŒ–çš„ UI

**å‘åå…¼å®¹ï¼š**
- âœ… ä¿ç•™åŸæœ‰ Claude API æ”¯æŒ
- âœ… ä¿ç•™åŸæœ‰é…ç½®æ–¹å¼ï¼ˆå¯é€‰ï¼‰

---

## æ”¯æŒå’Œè´¡çŒ®

- é—®é¢˜åé¦ˆï¼šGitHub Issues
- åŠŸèƒ½å»ºè®®ï¼šGitHub Discussions
- è´¡çŒ®ä»£ç ï¼šPull Requests

---

## è®¸å¯è¯

MIT License
